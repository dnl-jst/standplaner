{% extends 'base.html.twig' %}

{% block title %}Teilnehmer-Übersicht - Standplaner{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header mit Statistiken -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <div>
                    <h1 class="h2 mb-2">
                        <i class="bi bi-people me-2"></i>
                        Teilnehmer-Übersicht
                    </h1>
                    <p class="text-muted mb-0">Kompakte Übersicht aller Anmeldungen</p>
                </div>

                <!-- Statistik-Badges -->
                <div class="d-flex flex-wrap gap-2 mt-3 mt-md-0">
                    <span class="badge bg-primary fs-6">
                        <i class="bi bi-people me-1"></i>
                        {{ stats.totalParticipants }} Personen
                    </span>
                    <span class="badge bg-info fs-6">
                        <i class="bi bi-list-check me-1"></i>
                        {{ stats.totalParticipations }} Anmeldungen
                    </span>
                    {% if stats.attendingCount > 0 %}
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-check-circle-fill me-1"></i>
                            {{ stats.attendingCount }} Zusagen
                        </span>
                    {% endif %}
                    {% if stats.maybeCount > 0 %}
                        <span class="badge bg-warning fs-6">
                            <i class="bi bi-question-circle-fill me-1"></i>
                            {{ stats.maybeCount }} Vielleicht
                        </span>
                    {% endif %}
                    {% if stats.notAttendingCount > 0 %}
                        <span class="badge bg-danger fs-6">
                            <i class="bi bi-x-circle-fill me-1"></i>
                            {{ stats.notAttendingCount }} Absagen
                        </span>
                    {% endif %}
                </div>
            </div>

            {% if participants is empty %}
                <!-- Keine Teilnehmer -->
                <div class="alert alert-info text-center py-5">
                    <i class="bi bi-person-plus display-4 text-muted mb-3"></i>
                    <h4>Noch keine Teilnehmer registriert</h4>
                    <p class="mb-3">Es haben sich noch keine Personen für Wahlkampfstände angemeldet.</p>
                    <a href="{{ path('app_participation') }}" class="btn btn-primary">
                        <i class="bi bi-person-plus me-2"></i>
                        Jetzt anmelden
                    </a>
                </div>
            {% else %}
                <!-- Responsive Tabelle -->
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                                                        <table class="table table-hover mb-0 table-striped" id="participantTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th scope="col" class="px-3 py-3 bg-dark participant-col">
                                            <i class="bi bi-person me-2"></i>
                                            Teilnehmer
                                        </th>
                                        {% for stand in stands %}
                                            <th scope="col" class="text-center px-2 py-3 bg-dark stand-col" style="min-width: 120px;">
                                                <div class="small">
                                                    <div class="fw-bold">{{ stand.district }}</div>
                                                    <div class="text-light opacity-75">
                                                        {{ stand.startTime|date('d.m.') }}
                                                    </div>
                                                    <div class="text-light opacity-75">
                                                        {{ stand.startTime|date('H:i') }}
                                                    </div>
                                                </div>
                                            </th>
                                        {% endfor %}
                                        <th scope="col" class="text-center px-3 py-3 bg-dark total-col">
                                            <i class="bi bi-graph-up me-1"></i>
                                            Gesamt
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participant in participants %}
                                        <tr>
                                            <td class="px-3 py-2 participant-col">
                                                <div class="d-flex align-items-center">
                                                    <span class="fw-medium">{{ participant.name }}</span>
                                                    <span class="tooltip-wrapper ms-2">
                                                        <i class="bi bi-clock text-muted tooltip-icon"
                                                           style="font-size: 0.8rem; cursor: help;"></i>
                                                        <div class="custom-tooltip">
                                                            Anmeldungszeitpunkt:<br>
                                                            {{ participant.createdAt|date('d.m.Y H:i') }}
                                                        </div>
                                                    </span>
                                                </div>
                                            </td>

                                            {% for stand in stands %}
                                                <td class="text-center px-2 py-2 stand-col">
                                                    {% set status = null %}
                                                    {% for participation in participant.participations %}
                                                        {% if participation.campaignStand.id == stand.id %}
                                                            {% set status = participation.status %}
                                                        {% endif %}
                                                    {% endfor %}

                                                    {% if status == 'attending' %}
                                                        <span class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1" title="Nimmt teil">
                                                            <i class="bi bi-check-circle-fill"></i>
                                                        </span>
                                                    {% elseif status == 'maybe' %}
                                                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1" title="Vielleicht">
                                                            <i class="bi bi-question-circle-fill"></i>
                                                        </span>
                                                    {% elseif status == 'not_attending' %}
                                                        <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-2 py-1" title="Nimmt nicht teil">
                                                            <i class="bi bi-x-circle-fill"></i>
                                                        </span>
                                                    {% else %}
                                                        <span class="text-muted" title="Keine Anmeldung">
                                                            <i class="bi bi-dash"></i>
                                                        </span>
                                                    {% endif %}
                                                </td>
                                            {% endfor %}

                                            <!-- Gesamt-Spalte -->
                                            <td class="text-center px-3 py-2 total-col">
                                                {% set attendingTotal = 0 %}
                                                {% set maybeTotal = 0 %}
                                                {% set notAttendingTotal = 0 %}

                                                {% for participation in participant.participations %}
                                                    {% if participation.status == 'attending' %}
                                                        {% set attendingTotal = attendingTotal + 1 %}
                                                    {% elseif participation.status == 'maybe' %}
                                                        {% set maybeTotal = maybeTotal + 1 %}
                                                    {% elseif participation.status == 'not_attending' %}
                                                        {% set notAttendingTotal = notAttendingTotal + 1 %}
                                                    {% endif %}
                                                {% endfor %}

                                                <div class="d-flex justify-content-center gap-1">
                                                    {% if attendingTotal > 0 %}
                                                        <span class="badge bg-success rounded-pill" title="{{ attendingTotal }} Zusagen">
                                                            {{ attendingTotal }}
                                                        </span>
                                                    {% endif %}
                                                    {% if maybeTotal > 0 %}
                                                        <span class="badge bg-warning rounded-pill" title="{{ maybeTotal }} Vielleicht">
                                                            {{ maybeTotal }}
                                                        </span>
                                                    {% endif %}
                                                    {% if notAttendingTotal > 0 %}
                                                        <span class="badge bg-danger rounded-pill" title="{{ notAttendingTotal }} Absagen">
                                                            {{ notAttendingTotal }}
                                                        </span>
                                                    {% endif %}
                                                    {% if attendingTotal == 0 and maybeTotal == 0 and notAttendingTotal == 0 %}
                                                        <span class="text-muted small">Keine</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>

                                <!-- Gesamt-Zeile -->
                                <tfoot class="table-light">
                                    <tr>
                                        <td class="px-3 py-2 fw-bold">
                                            <i class="bi bi-graph-up me-2"></i>
                                            Gesamt pro Stand
                                        </td>
                                        {% for stand in stands %}
                                            <td class="text-center px-2 py-2">
                                                {% set standAttending = 0 %}
                                                {% set standMaybe = 0 %}
                                                {% set standNotAttending = 0 %}

                                                {% for participation in stand.participations %}
                                                    {% if participation.status == 'attending' %}
                                                        {% set standAttending = standAttending + 1 %}
                                                    {% elseif participation.status == 'maybe' %}
                                                        {% set standMaybe = standMaybe + 1 %}
                                                    {% elseif participation.status == 'not_attending' %}
                                                        {% set standNotAttending = standNotAttending + 1 %}
                                                    {% endif %}
                                                {% endfor %}

                                                <div class="d-flex flex-column gap-1">
                                                    {% if standAttending > 0 %}
                                                        <span class="badge bg-success rounded-pill">
                                                            <i class="bi bi-check-circle-fill me-1"></i>{{ standAttending }}
                                                        </span>
                                                    {% endif %}
                                                    {% if standMaybe > 0 %}
                                                        <span class="badge bg-warning rounded-pill">
                                                            <i class="bi bi-question-circle-fill me-1"></i>{{ standMaybe }}
                                                        </span>
                                                    {% endif %}
                                                    {% if standNotAttending > 0 %}
                                                        <span class="badge bg-danger rounded-pill">
                                                            <i class="bi bi-x-circle-fill me-1"></i>{{ standNotAttending }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        {% endfor %}
                                        <td class="text-center px-3 py-2 fw-bold">
                                            {{ stats.totalParticipations }}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Aktions-Buttons -->
                <div class="d-flex flex-column flex-sm-row gap-2 mt-4">
                    <a href="{{ path('app_participation') }}" class="btn btn-success">
                        <i class="bi bi-person-plus me-2"></i>
                        Neue Anmeldung
                    </a>
                    <a href="{{ path('app_home') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Zurück zur Übersicht
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Responsive Optimierungen */
@media (max-width: 767.98px) {
    .table-responsive {
        font-size: 0.875rem;
    }

    .badge {
        font-size: 0.75rem;
    }
}

/* Hover-Effekte */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* Sticky Header für große Tabellen */
@media (min-width: 768px) {
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
    }
}

/* Custom Tooltip Styles */
.tooltip-wrapper {
    position: relative;
    display: inline-block;
}

.custom-tooltip {
    visibility: hidden;
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    text-align: center;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s, visibility 0.3s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.custom-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

.tooltip-wrapper:hover .custom-tooltip {
    visibility: visible;
    opacity: 1;
}

.tooltip-icon:hover {
    color: #0d6efd !important;
    transition: color 0.2s ease-in-out;
}

/* Column styling */
.participant-col {
    background-color: rgba(13, 110, 253, 0.05) !important; /* Leichtes Blau für Teilnehmer */
}

.stand-col {
    background-color: rgba(25, 135, 84, 0.05) !important; /* Leichtes Grün für Stände */
}

.total-col {
    background-color: rgba(255, 193, 7, 0.1) !important; /* Leichtes Gelb für Gesamt */
    font-weight: 500;
}

/* Table striping enhancement */
.table-striped > tbody > tr:nth-of-type(odd) .participant-col {
    background-color: rgba(13, 110, 253, 0.08) !important;
}

.table-striped > tbody > tr:nth-of-type(odd) .stand-col {
    background-color: rgba(25, 135, 84, 0.08) !important;
}

.table-striped > tbody > tr:nth-of-type(odd) .total-col {
    background-color: rgba(255, 193, 7, 0.15) !important;
}
</style>
{% endblock %}
